SELECT scr_acct_id AS CUST_ACCT_ID, HUB_SCR_REF, TRANSACTION_DATE, FIRST_REMITTANCE_AMOUNT, SENDER_HP, CUSTOMER_NAME, DT_CREATED, DT_REG, DT_VFYD, ACCT_NATLY, BENEFICIARY_NATLY, REMITTANCE_TYPE, STAT, CREATED_USER_ID, REG_USER_ID
FROM
(
SELECT comb.*, 
(CASE
WHEN svc_class_name LIKE '%Mobile%' THEN 'Mobile'
WHEN svc_class_name LIKE '%Counter%' THEN 'Counter' END) REMITTANCE_TYPE,
bene.natly AS BENEFICIARY_NATLY
FROM
(
SELECT txn.*, dt_created, dt_reg, dt_vfyd, acct_natly, created_user_id, reg_user_id, acct_prin_name AS CUSTOMER_NAME
FROM
(SELECT b.scr_acct_id,b.ACCT_MSISDN AS SENDER_HP,b.svc_class_name,b.dest_acct_id,b.txn_id AS HUB_SCR_REF,b.stat,a.SRC_DEBIT AS FIRST_REMITTANCE_AMOUNT, a.SRC_DEBIT, a.TXN_DT,to_char(a.TXN_DT,'DD-Mon-YYYY') AS TRANSACTION_DATE, RANK() OVER (PARTITION BY b.scr_acct_id ORDER BY b.txn_id) AS rank_txn_id
FROM EDWDM.TEDW_SINGCASH_SALESJOURNAL_HUB a
INNER JOIN EDWDM.TEDW_SINGCASH_SALESJOURNAL_DOM b
ON a.scr_ref = b.txn_id
WHERE a.STAT LIKE '%PST%'
--AND b.CUST_MSISDN NOT IN ('6583381170','6597727199','6596510899')
AND b.CUST_MSISDN != '6583381170' 
AND b.CUST_MSISDN != '6597727199'
AND b.CUST_MSISDN != '6596510899'
And b.data_txn_rfnd = 'False'
--AND a.TXN_DT BETWEEN TO_DATE('24-Mar-2019','DD-Mon-YYYY') AND TO_DATE('25-Apr-2019','DD-Mon-YYYY')
) txn
INNER JOIN EDWDM.TEDW_SINGCASH_ACCOUNT demo
ON txn.scr_acct_id = demo.acct_id) comb 
INNER JOIN EDWDM.TEDW_SINGCASH_ACCT_BENEFICIARY bene
ON comb.dest_acct_id = bene.bency_id
WHERE RANK_TXN_ID = 1
AND txn_dt BETWEEN TO_DATE('01-Mar-2019','DD-Mon-YYYY') AND TO_DATE('01-Apr-2019','DD-Mon-YYYY')
AND FIRST_REMITTANCE_AMOUNT >= 100
ORDER BY txn_dt ASC) final






